<!doctype html>
<html lang="en">
<head>
    <!--
      SnipeRank - Full Report Page
      Version: 2.1.0
      Date: 2025-08-24
      Changes:
        - Compact score header (removed full scorecard duplication)
        - Reads score/report data from sessionStorage to avoid re-run
        - Added fallback fetch with progress bar if no cached data
    -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipeRank – Full Report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fafafa;color:#111;margin:0}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:14px;padding:16px 18px;box-shadow:0 2px 6px rgba(0,0,0,.04);margin-bottom:16px}
    .headerRow{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .scoreBadge{display:flex;align-items:center;gap:10px}
    .scoreDot{width:48px;height:48px;border-radius:12px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800}
    .muted{color:#666}
    .section h3{margin:8px 0}
    button{padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:600;cursor:pointer}
    /* minimal progress (fallback if fetch required) */
    .bar{height:8px;border-radius:8px;background:#eee;overflow:hidden}
    .bar>div{height:100%;width:0%;background:#111}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="top" class="card">
      <div class="headerRow">
        <div>
          <div class="muted" id="urlLabel">—</div>
          <div class="scoreBadge">
            <div class="scoreDot" id="scoreDot">—</div>
            <div>
              <div style="font-weight:700">SnipeRank Score</div>
              <div class="muted" style="font-size:13px">Compact view (full card hidden on this page)</div>
            </div>
          </div>
        </div>
        <div>
          <button id="backBtn">← Back to Analyze</button>
        </div>
      </div>
    </div>

    <div id="loading" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between">
        <strong>Building full report…</strong>
        <span id="pct">0%</span>
      </div>
      <div class="bar" style="margin-top:8px"><div id="fill"></div></div>
      <div class="muted" style="margin-top:8px">Allow <strong>2–4 minutes</strong> as we scan and analyze your live website…</div>
    </div>

    <div id="content" class="card" style="display:none">
      <div class="section">
        <h3>Highlights</h3>
        <div id="highlights" class="muted">—</div>
      </div>
      <div class="section">
        <h3>Superpowers</h3>
        <ul id="superpowers"></ul>
      </div>
      <div class="section">
        <h3>Opportunities</h3>
        <ul id="opportunities"></ul>
      </div>
      <div class="section">
        <h3>Insights</h3>
        <ul id="insights"></ul>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const url = params.get('url') || sessionStorage.getItem('snipeReport:url') || '';

    const urlLabel = document.getElementById('urlLabel');
    const dot = document.getElementById('scoreDot');
    const content = document.getElementById('content');
    const loading = document.getElementById('loading');
    const backBtn = document.getElementById('backBtn');

    backBtn.onclick = ()=>history.length>1 ? history.back() : (location.href='analyze.html');

    urlLabel.textContent = url || '—';

    // Try to reuse existing analysis (no re-run)
    let report = null;
    try {
      const cached = sessionStorage.getItem('snipeReport:data');
      if (cached) report = JSON.parse(cached);
    } catch(e){}

    if (report) {
      renderHeader(report);
      renderReport(report);
    } else if (url) {
      // Fallback: fetch once if user landed here directly
      fetchWithProgress(url);
    } else {
      dot.textContent = '—';
      document.getElementById('content').innerHTML = '<div class="muted">No data found. Please run an analysis first.</div>';
      content.style.display = 'block';
    }

    function renderHeader(r){
      const s = r?.score ?? r?.data?.score ?? '—';
      dot.textContent = s;
    }

    function renderReport(r){
      const hp = document.getElementById('highlights');
      const sp = document.getElementById('superpowers');
      const op = document.getElementById('opportunities');
      const inx = document.getElementById('insights');

      hp.textContent = r?.summary || r?.highlights || '—';

      (r?.superpowers || []).forEach(t=>{
        const li=document.createElement('li'); li.textContent=t; sp.appendChild(li);
      });
      (r?.opportunities || []).forEach(t=>{
        const li=document.createElement('li'); li.textContent=t; op.appendChild(li);
      });
      (r?.insights || []).forEach(t=>{
        const li=document.createElement('li'); li.textContent=t; inx.appendChild(li);
      });

      content.style.display = 'block';
    }

    async function fetchWithProgress(u){
      loading.style.display = 'block';
      const fill = document.getElementById('fill');
      const pct = document.getElementById('pct');
      let p = 0;
      const t = setInterval(()=>{
        const inc = p < 60 ? 2.0 : p < 85 ? 0.9 : 0.25;
        p = Math.min(p + inc, 95);
        fill.style.width = p+'%'; pct.textContent = Math.floor(p)+'%';
      }, 250);

      try{
        const resp = await fetch(`/api/friendly?url=${encodeURIComponent(u)}`);
        if(!resp.ok) throw new Error('Failed to load report');
        const data = await resp.json();
        // Save for future navigations in-session
        sessionStorage.setItem('snipeReport:url', u);
        sessionStorage.setItem('snipeReport:data', JSON.stringify(data));
        renderHeader(data);
        renderReport(data);
      }catch(err){
        loading.innerHTML = `<div class="muted">Error: ${err.message}</div>`;
      }finally{
        clearInterval(t);
        fill.style.width = '100%'; pct.textContent = '100%';
        setTimeout(()=>{ loading.style.display='none'; }, 250);
      }
    }
  </script>
</body>
</html>
