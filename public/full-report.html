<!doctype html>
<html lang="en">
<head>
  <!-- full-report.html - v3.0.0 - Integrated clean version with session storage and compact header -->
  <!-- Features: Reuses analyze.html data, comprehensive 300-page analysis, compact score display, progress fallback -->
  <!-- Compatible with: server.js v2.6.0+ (/api/score and /report.html?report=full endpoints) -->
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipeRank - Full AI SEO Report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fafafa;color:#111;margin:0}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px}
    
    /* Compact header */
    .header-card{background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:16px 20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:20px}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .score-compact{display:flex;align-items:center;gap:12px}
    .score-dot{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#000 0%,#3182CE 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px}
    .score-info h1{margin:0;font-size:20px;font-weight:700}
    .score-info .url{color:#666;font-size:14px;margin:2px 0 0}
    .back-btn{padding:10px 16px;border:1px solid #ddd;border-radius:10px;background:#fff;color:#111;font-weight:600;cursor:pointer;text-decoration:none;transition:background .2s}
    .back-btn:hover{background:#f5f5f5}
    
    /* Content cards */
    .card{background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:20px}
    .section h3{margin:0 0 16px;font-size:18px;font-weight:700;color:#333}
    .section h4{margin:16px 0 8px;font-size:16px;font-weight:600;color:#333}
    
    /* Report content styling */
    .section-title{font-size:16px!important;font-weight:700!important;margin:20px 0 12px!important;color:#333!important}
    .section ul{margin:0 0 16px 0!important;padding-left:20px!important}
    .section li{line-height:1.6!important;margin:8px 0!important;font-size:14px!important}
    .section li strong{color:#111!important}
    
    /* LLM insights styling */
    .llm-insights{display:grid;gap:12px;margin:16px 0}
    .llm-row{display:flex;gap:12px;align-items:flex-start;padding:14px;border:1px solid #eee;border-radius:10px;background:#fafafa}
    .llm-logo{min-width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#fff;border:1px solid #ddd;font-size:11px;font-weight:700;color:#666}
    .llm-content{flex:1;font-size:14px;line-height:1.6;color:#333}
    
    /* Progress (fallback) */
    .loading-card{text-align:center;padding:40px 20px}
    .progress-bar{height:8px;border-radius:6px;background:#eee;overflow:hidden;margin:16px 0;max-width:300px;margin-left:auto;margin-right:auto}
    .progress-fill{height:100%;background:linear-gradient(90deg,#3182CE,#1a73e8);border-radius:6px;width:0%;transition:width .3s ease}
    .progress-text{color:#666;font-size:14px;margin:8px 0}
    
    /* CTA section */
    .cta-section{text-align:center;padding:24px;border-top:1px solid #eee;margin-top:20px}
    .cta-section h3{margin:0 0 8px;font-size:20px}
    .cta-section p{color:#666;margin:8px 0 16px}
    .btn-primary{background:#dc3545;color:#fff;border:none;padding:12px 20px;border-radius:10px;font-weight:600;text-decoration:none;transition:background .2s}
    .btn-primary:hover{background:#c82333}
    
    .muted{color:#666}
    .text-center{text-align:center}
    .hidden{display:none}
    
    @media (max-width: 768px) {
      .header-row{flex-direction:column;align-items:stretch;gap:12px}
      .score-compact{justify-content:center}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Compact Header -->
    <div class="header-card">
      <div class="header-row">
        <div class="score-compact">
          <div class="score-dot" id="score-dot">-</div>
          <div class="score-info">
            <h1>Full AI SEO Report</h1>
            <div class="url" id="url-display">-</div>
          </div>
        </div>
        <a href="#" class="back-btn" id="back-btn">‚Üê Back to Analysis</a>
      </div>
    </div>

    <!-- Loading state (fallback) -->
    <div id="loading-card" class="card loading-card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;max-width:300px;margin:0 auto 16px">
        <strong>Generating comprehensive report...</strong>
        <span id="progress-pct" class="muted">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text">
        Analyzing up to <strong>300 pages</strong> for comprehensive insights.<br>
        This may take <strong>2-4 minutes</strong> for thorough analysis.
      </div>
    </div>

    <!-- Report Content -->
    <div id="content-card" class="card">
      <div class="section" id="report-content">
        <p class="text-center muted">Loading comprehensive analysis...</p>
      </div>
      
      <!-- Consultation CTA -->
      <div class="cta-section">
        <h3>Ready to Improve Your AI Visibility?</h3>
        <p>Schedule a free 30-minute consultation to discuss your optimization opportunities.</p>
        <a href="https://calendly.com/quontora" class="btn-primary" target="_blank" rel="noopener">
          Schedule Free Consultation
        </a>
      </div>
    </div>
  </div>

  <script>
    // Get URL from params or session storage
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('url') || sessionStorage.getItem('sniperank:url') || '';
    
    // Elements
    const scoreDot = document.getElementById('score-dot');
    const urlDisplay = document.getElementById('url-display');
    const backBtn = document.getElementById('back-btn');
    const loadingCard = document.getElementById('loading-card');
    const contentCard = document.getElementById('content-card');
    const reportContent = document.getElementById('report-content');
    
    // Set URL display
    urlDisplay.textContent = targetUrl || 'No URL specified';
    
    // Back button
    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (history.length > 1) {
        history.back();
      } else {
        window.location.href = 'analyze.html';
      }
    });
    
    // Try to load cached data first
    let cachedData = null;
    try {
      const cached = sessionStorage.getItem('sniperank:data');
      if (cached) {
        cachedData = JSON.parse(cached);
      }
    } catch (e) {
      console.log('No cached data found');
    }
    
    if (cachedData && targetUrl) {
      // Use cached data, but fetch full report
      renderHeader(cachedData);
      fetchFullReport(targetUrl);
    } else if (targetUrl) {
      // No cached data, fetch everything
      fetchCompleteAnalysis(targetUrl);
    } else {
      // No URL provided
      reportContent.innerHTML = `
        <div class="text-center muted">
          <strong>No analysis data found</strong><br>
          Please run an analysis first from the main page.
        </div>
      `;
    }
    
    function renderHeader(data) {
      if (data && data.score) {
        scoreDot.textContent = data.score;
      }
    }
    
    async function fetchFullReport(url) {
      try {
        // Check API availability
        let apiBase = '';
        try {
          const probe = await fetch('/api/score?url=' + encodeURIComponent('https://example.com'), {method:'HEAD'});
          if (!probe.ok) apiBase = 'https://sniperank-app2.onrender.com';
        } catch {
          apiBase = 'https://sniperank-app2.onrender.com';
        }
        
        // Fetch full report (300 pages)
        const reportResponse = await fetch(`${apiBase}/report.html?report=full&url=${encodeURIComponent(url)}`);
        if (!reportResponse.ok) throw new Error('Full report generation failed');
        
        const reportHtml = await reportResponse.text();
        reportContent.innerHTML = reportHtml;
        
        // Transform AI insights
        transformAIInsights(reportContent);
        
      } catch (error) {
        console.error('Full report error:', error);
        reportContent.innerHTML = `
          <div class="text-center muted">
            <strong>Error loading full report</strong><br>
            ${error.message}<br><br>
            The analysis may still be processing. Please try again in a moment.
          </div>
        `;
      }
    }
    
    async function fetchCompleteAnalysis(url) {
      // Show loading
      loadingCard.classList.remove('hidden');
      
      // Start progress simulation
      const progressFill = document.getElementById('progress-fill');
      const progressPct = document.getElementById('progress-pct');
      let progress = 0;
      
      const progressTimer = setInterval(() => {
        const increment = progress < 40 ? 1.5 : progress < 70 ? 0.8 : 0.3;
        progress = Math.min(progress + increment, 95);
        progressFill.style.width = progress + '%';
        progressPct.textContent = Math.floor(progress) + '%';
      }, 300);
      
      try {
        // Check API availability
        let apiBase = '';
        try {
          const probe = await fetch('/api/score?url=' + encodeURIComponent('https://example.com'), {method:'HEAD'});
          if (!probe.ok) apiBase = 'https://sniperank-app2.onrender.com';
        } catch {
          apiBase = 'https://sniperank-app2.onrender.com';
        }
        
        // Fetch score data
        const scoreResponse = await fetch(`${apiBase}/api/score?url=${encodeURIComponent(url)}`);
        if (!scoreResponse.ok) throw new Error('Analysis failed');
        const scoreData = await scoreResponse.json();
        
        // Update header
        renderHeader(scoreData);
        
        // Fetch full report
        const reportResponse = await fetch(`${apiBase}/report.html?report=full&url=${encodeURIComponent(url)}`);
        if (!reportResponse.ok) throw new Error('Full report generation failed');
        
        const reportHtml = await reportResponse.text();
        
        // Store data
        const fullData = {
          score: scoreData.score,
          pillars: scoreData.pillars,
          highlights: scoreData.highlights,
          band: scoreData.band,
          reportHtml: reportHtml,
          insights: scoreData.insights
        };
        
        sessionStorage.setItem('sniperank:url', url);
        sessionStorage.setItem('sniperank:data', JSON.stringify(fullData));
        
        // Render report
        reportContent.innerHTML = reportHtml;
        transformAIInsights(reportContent);
        
      } catch (error) {
        console.error('Complete analysis error:', error);
        reportContent.innerHTML = `
          <div class="text-center muted">
            <strong>Analysis Error</strong><br>
            ${error.message}<br><br>
            Please check the URL and try again from the analysis page.
          </div>
        `;
      } finally {
        clearInterval(progressTimer);
        progressFill.style.width = '100%';
        progressPct.textContent = '100%';
        setTimeout(() => {
          loadingCard.classList.add('hidden');
        }, 500);
      }
    }
    
    // Transform AI insights section to logo format
    function transformAIInsights(container) {
      const title = [...container.querySelectorAll('h2,h3,h4,.section-title')].find(n => 
        /ai\s*engine\s*insights?/i.test((n.textContent || '').trim())
      );
      
      if (!title) return;
      
      let ul = title.nextElementSibling;
      while (ul && ul.tagName && ul.tagName.toLowerCase() !== 'ul') ul = ul.nextElementSibling;
      if (!ul) return;
      
      const bullets = [...ul.querySelectorAll('li')].map(li => (li.textContent || '').trim());
      if (!bullets.length) return;
      
      const engines = ['ChatGPT', 'Claude', 'Gemini', 'Copilot', 'Perplexity'];
      const insightsContainer = document.createElement('div');
      insightsContainer.className = 'llm-insights';
      
      engines.forEach((engine, i) => {
        const text = bullets[i];
        if (!text) return;
        
        const row = document.createElement('div');
        row.className = 'llm-row';
        row.innerHTML = `
          <div class="llm-logo">${engine}</div>
          <div class="llm-content">${text}</div>
        `;
        insightsContainer.appendChild(row);
      });
      
      ul.replaceWith(insightsContainer);
    }
  </script>
</body>
</html>
