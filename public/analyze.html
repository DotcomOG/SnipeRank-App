<!--
  Version: 1.10.3
  Last Updated: Aug 11, 2025
  Changes in this patch ONLY:
  - Analyze page now enforces bullet counts after injecting backend HTML:
      * What's Working: cap at 5
      * Needs Attention: ensure at least 10 (domain-specific backfill if short)
  - No other code/behavior changed
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Document metadata + responsive viewport -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SnipeRank ‚Äî AI SEO Analysis Results</title>

  <!--
    Global styles:
    - Container width, typography, tokens (colors, radii)
    - Scorecard, pillars, highlights
    - Server-rendered section type locks (heading/list spacing)
    - LLM logos layout
    - Lead form + CTA
    - Modal (methodology)
    Note: CSS is kept compact for load speed.
  -->
  <style>
    :root{
      --max-width:760px; --pad-v:3vh; --pad-h:2rem;
      --muted:#666; --border:#e5e5e5;
      --sr-radius:16px; --sr-border:#e6e6e9; --sr-shadow:0 10px 30px rgba(0,0,0,.12);
      --sr-text:#111; --sr-muted:#5b5b66; --sr-bg:#fff; --sr-pill-bg:#fafafb; --sr-gap:16px;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:#fff;color:#000;margin:0;padding:var(--pad-v) var(--pad-h);max-width:var(--max-width);margin-inline:auto;display:flex;flex-direction:column;align-items:flex-start}
    h1{font-size:4rem;font-weight:700;margin:0 0 .25em 0;line-height:1;letter-spacing:-1px;background:linear-gradient(135deg,#000 0%,#3182CE 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    h2{font-size:1.6rem;font-weight:700;margin:0 0 1rem 0}
    p{font-size:1.075rem;line-height:1.65;margin:0 0 1rem 0}

    .info-row{width:100%;display:flex;gap:1rem;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
    .powered-by,.for-url{color:var(--muted);font-size:.95rem}
    .powered-by a{color:#3182CE;text-decoration:none;font-weight:600}
    .for-url strong{color:#000}

    .card{width:100%;border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
    .score-card{padding:1rem;margin-bottom:2.25rem}
    .score-top{display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap}
    .score-main{display:flex;align-items:baseline;gap:.5rem}
    .score-number{font-size:2.25rem;font-weight:800}
    .score-band{color:var(--muted);font-size:.95rem}
    .btn-row{display:flex;gap:.5rem;align-items:center}
    .btn-ghost{border:1px solid #111;background:#fff;color:#111;padding:.55rem .9rem;border-radius:8px;cursor:pointer;font-weight:700;font-size:.95rem;transition:.2s}
    .btn-ghost:hover{background:#f2f2f2}
    .pillars{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem}
    .pillar{border:1px solid var(--border);border-radius:10px;padding:.6rem .75rem;display:flex;align-items:center;justify-content:space-between;font-size:.98rem;background:#fff}
    .pillar .label{font-weight:600}
    .badge{font-weight:700;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fafafa}
    .highlights{margin-top:.9rem;padding-top:.9rem;border-top:1px dashed var(--border)}
    .highlights h4{margin:0 0 .55rem 0;font-size:1.2rem;font-weight:800}
    .highlights ul{margin:0;padding-left:1rem}
    .highlights li{margin:.45rem 0;line-height:1.5}

    #summary-results .section-title{font-size:1.25rem!important;font-weight:700!important;margin:2rem 0 .6rem 0!important}
    #summary-results p{line-height:1.65!important;margin:0 0 .9rem 0!important;font-size:1.02rem!important}
    #summary-results ul{margin:0 0 1.1rem 1.1rem!important;padding-left:.2rem!important;list-style:disc!important}
    #summary-results li{line-height:1.6!important;margin:.55rem 0!important;font-size:1.02rem!important}

    .llm-insights{margin:.4rem 0 1.2rem}
    .llm-row{display:grid;grid-template-columns:auto 1fr;gap:.8rem 1rem;align-items:start;padding:.8rem 0;border-bottom:1px dashed var(--border)}
    .llm-row:last-child{border-bottom:0}
    .llm-logo{display:flex;align-items:center;justify-content:center;min-width:42px;height:32px}
    .llm-logo img{height:28px;width:auto;display:block;object-fit:contain;max-width:110px}
    .llm-fallback{display:inline-flex;align-items:center;justify-content:center;height:28px;padding:0 .75rem;border:1px solid var(--border);border-radius:6px;font-size:.85rem;font-weight:600;color:#333;background:#f8f9fa}

    .report-section{width:100%;margin:2.5rem 0}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
    input,textarea{width:100%;padding:.75rem 1rem;border:1px solid #ddd;border-radius:8px;font-size:1rem;font-family:inherit;transition:border-color .2s}
    input:focus,textarea:focus{outline:none;border-color:#3182CE}
    textarea{resize:vertical;min-height:100px}
    .btn-primary{background:#dc3545;color:#fff;border:none;padding:.85rem 2rem;border-radius:8px;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background .2s;display:inline-block;text-decoration:none;text-align:center;margin:1rem 0}
    .btn-primary:hover{background:#c82333}
    .form-button-wrapper{text-align:center;margin:1.5rem 0}

    /* Center the consultation section + button */
    .consultation-section{text-align:center;margin:2.5rem 0}
    .consultation-cta .btn-primary{display:inline-block;text-decoration:none}

    .footer{width:100%;text-align:center;padding:2rem 0 1rem;margin-top:3rem;border-top:1px solid var(--border);color:#666;font-size:.9rem}

    .sr-modal{position:fixed;inset:0;display:none;z-index:9999}
    .sr-modal[aria-hidden="false"]{display:block}
    .sr-modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.3)}
    .sr-modal__panel{position:relative;max-width:720px;width:calc(100% - 32px);margin:6vh auto;background:var(--sr-bg);color:var(--sr-text);border:1px solid var(--sr-border);border-radius:var(--sr-radius);box-shadow:var(--sr-shadow);padding:20px;max-height:90vh;overflow-y:auto}
    .sr-modal__close{position:absolute;top:10px;right:10px;border:1px solid var(--sr-border);background:#fff;border-radius:999px;width:32px;height:32px;line-height:28px;font-size:18px;cursor:pointer;text-align:center}
    .sr-modal__header h2{margin:0 0 4px;font-size:18px;font-weight:700}
    .sr-modal__sub{margin:0 0 12px;color:var(--sr-muted);font-size:14px;line-height:1.35}
    .sr-pill{background:var(--sr-pill-bg);border:1px solid var(--sr-border);border-radius:12px;padding:12px 14px;margin-bottom:var(--sr-gap)}
    .sr-pill__title{margin:0 0 6px;font-size:15px;font-weight:700}
    .sr-list{margin:0;padding-left:18px}
    .sr-list li{margin:6px 0;line-height:1.35}
    .sr-modal__fineprint{margin-top:8px;color:var(--sr-muted);font-size:12px;line-height:1.3;border-top:1px dashed var(--sr-border);padding-top:10px}

    @media(max-width:600px){.pillars{grid-template-columns:1fr}h1{font-size:3rem}.form-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Product title + subtitle -->
  <h1>SnipeRank</h1>
  <h2>AI SEO Analysis Results</h2>

  <!-- Small context row: left = "Powered by", right = current URL (set by JS) -->
  <div class="info-row">
    <div class="powered-by">Powered by <a href="https://quontora.com" target="_blank" rel="noopener">quontora</a></div>
    <div class="for-url">Analysis for: <strong id="current-url">‚Äî</strong></div>
  </div>

  <!-- Score Card (populated by JS: score, rank text, pillar grid, highlights) -->
  <section class="card score-card" id="scoreCard" aria-live="polite">
    <div class="score-top">
      <div class="score-main">
        <div class="score-number" id="scoreNumber">‚Äî</div>
        <div class="score-band" id="scoreBand">Calculating‚Ä¶</div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" type="button" data-open="sr-modal">View Scoring Methodology</button>
        <button class="btn-ghost" id="copyLLMBtn" type="button">Copy Shareable Summary</button>
      </div>
    </div>
    <div class="pillars" id="pillarsGrid"></div>
    <div class="highlights" id="highlightsBlock" hidden>
      <h4>Highlights</h4>
      <ul id="highlightsList"></ul>
    </div>
  </section>

  <!-- Server-rendered HTML from backend inserted here by JS -->
  <section id="summary-results">
    <p style="text-align:center;color:gray;">Loading analysis...</p>
  </section>

  <!-- Lead form: submits to Formspree; JS always redirects to /full-report.html?url=... -->
  <section class="report-section">
    <h3>Get Your Full Report</h3>
    <form id="fullReportForm" action="https://formspree.io/f/xqalqjqd" method="POST">
      <div class="form-grid">
        <input type="text" name="name" placeholder="Your Name" required autocomplete="name"/>
        <input type="email" name="email" placeholder="Your Email" required autocomplete="email"/>
        <input type="tel" name="phone" placeholder="Your Phone (optional)" autocomplete="tel"/>
        <input type="text" name="company" placeholder="Your Company (optional)" autocomplete="organization"/>
      </div>
      <textarea name="message" placeholder="Share context or ask a specific question ‚Äî we'll address at your free consult." rows="4"></textarea>
      <input type="hidden" name="url" id="urlField"/>
      <input type="hidden" name="_subject" value="SnipeRank Full Report request"/>
      <div class="form-button-wrapper"><button type="submit" class="btn-primary">View Full Report Now</button></div>
      <p id="formMessage" style="text-align:center;font-size:.95rem;color:gray;"></p>
    </form>
  </section>

  <!-- Centered consultation CTA (Calendly) -->
  <section class="consultation-section">
    <h3>Ready to Improve Your AI Visibility?</h3>
    <p>After reviewing your analysis, book a free 30‚Äëminute consultation to discuss your specific opportunities and next steps.</p>
    <div class="consultation-cta">
      <a href="https://calendly.com/quontora" class="btn-primary" target="_blank" rel="noopener">Schedule Free Consultation</a>
    </div>
    <p class="consultation-note"><strong>What we'll cover:</strong> Your AI SEO opportunities, implementation timeline, and how to get found by ChatGPT, Gemini, and other AI platforms.</p>
  </section>

  <!-- Footer -->
  <div class="footer">¬© 2025 SnipeRank by <a href="https://quontora.com" target="_blank" rel="noopener" style="color:#3182CE;text-decoration:none;">quontora.com</a>. Last updated August 11.</div>

  <!-- Accessible Methodology Modal (opened via [data-open="sr-modal"]) -->
  <div id="sr-modal" class="sr-modal" aria-hidden="true" role="dialog" aria-labelledby="sr-modal-title">
    <div class="sr-modal__backdrop" data-close></div>
    <div class="sr-modal__panel" role="document">
      <button class="sr-modal__close" aria-label="Close" data-close>√ó</button>
      <header class="sr-modal__header">
        <h2 id="sr-modal-title">SnipeRank Scoring Methodology</h2>
        <p class="sr-modal__sub">Our proprietary model evaluates four pillars (+ freshness preview). Items below are representative checks used to guide recommendations.</p>
      </header>
      <section class="sr-pill"><h3 class="sr-pill__title">AI Access Readiness</h3><ul class="sr-list"><li>robots.txt, meta directives, and sitemap crawlability.</li><li>Core Web Vitals thresholds & render stability (LCP/CLS/INP).</li><li>Internal link discoverability (click depth, orphan risk).</li></ul></section>
      <section class="sr-pill"><h3 class="sr-pill__title">Trust & Verification Signals</h3><ul class="sr-list"><li>HTTPS/SSL health and redirect hygiene.</li><li>Organization/Person schema and verifiable profiles.</li><li>Contact/footprint consistency across key surfaces.</li></ul></section>
      <section class="sr-pill"><h3 class="sr-pill__title">LLM Interpretability & Clarity</h3><ul class="sr-list"><li>Headings that ladder to one core claim.</li><li>Structured elements (lists/Q&A/tables) over dense paragraphs.</li><li>Entity disambiguation: names, dates, roles, locations.</li></ul></section>
      <section class="sr-pill"><h3 class="sr-pill__title">Prompt-Pattern Alignment</h3><ul class="sr-list"><li>Answer-first summaries and "how/compare" FAQs.</li><li>Task framing suitable for AI snippets and summaries.</li><li>Schema coverage (FAQ, Article/BlogPosting, WebSite).</li></ul></section>
      <section class="sr-pill"><h3 class="sr-pill__title">Freshness & Engagement Signals</h3><ul class="sr-list"><li>Update cadence and last‚Äëmodified headers on key pages.</li><li>Data recency and time‚Äëboxed claims.</li><li>Interactive components and text equivalents.</li></ul></section>
      <footer class="sr-modal__fineprint">Exact weights are confidential. Scores include small variance to reflect signal confidence.</footer>
    </div>
  </div>

  <script>
    /**
     * LLM logo loader
     * 1) Tries local PNG in /img (and then 'img' without the leading slash)
     * 2) If image fails, falls back to a small inline SVG icon per engine
     * 3) If all else fails, shows a text pill with the engine name
     */

    // 1) Primary image sources (kept exactly as requested)
    const LOGO_SOURCES = {
      ChatGPT:    ['/img/chatgpt-logo.png'],
      Claude:     ['/img/claude-logo.png'],
      Gemini:     ['/img/gemini-logo.png'],
      Copilot:    ['/img/copilot-logo.png'],
      Perplexity: ['/img/perplexity-logo.png']
    };

    // 2) Inline SVG fallbacks ‚Äî sized to fit your .llm-logo (height: 28px)
    //    These aren‚Äôt official brand marks; they‚Äôre neutral glyphs so
    //    the layout never breaks if a PNG is missing.
    const ICON_SVGS = {
      ChatGPT: `
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <circle cx="12" cy="12" r="10" fill="#10a37f"/>
          <path d="M7 12h10M12 7v10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `,
      Claude: `
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <rect x="3" y="3" width="18" height="18" rx="4" fill="#ff6b2c"/>
          <path d="M7 12h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `,
      Gemini: `
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <circle cx="8" cy="12" r="5" fill="#1a73e8"/><circle cx="16" cy="12" r="5" fill="#4285f4" opacity="0.6"/>
        </svg>
      `,
      Copilot: `
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <rect x="3" y="6" width="18" height="12" rx="6" fill="#5c2d91"/>
          <path d="M8 12h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `,
      Perplexity: `
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <circle cx="12" cy="12" r="10" fill="#000"/>
          <circle cx="12" cy="12" r="3.5" fill="#fff"/>
        </svg>
      `
    };

    function logoDivFor(engine) {
      const wrap = document.createElement('div');
      wrap.className = 'llm-logo';

      const primary = (LOGO_SOURCES[engine] || [])[0];
      if (!primary) {
        wrap.innerHTML = `<span class="llm-fallback">${engine}</span>`;
        return wrap;
      }

      const candidates = [primary, primary.replace(/^\/+/, '')];
      const img = document.createElement('img');
      img.alt = `${engine} logo`;

      let i = 0;
      const tryNext = () => {
        if (i < candidates.length) {
          img.src = candidates[i++];
        } else {
          const svg = ICON_SVGS[engine];
          wrap.innerHTML = svg ? svg : `<span class="llm-fallback">${engine}</span>`;
        }
      };

      img.onload = () => { wrap.innerHTML = ''; wrap.appendChild(img); };
      img.onerror = tryNext;
      tryNext();

      return wrap;
    }

    /* -----------------------------------------------------------------------
       Main page logic (DOM ready):
       - Read ?url=... and print into header
       - Fetch server-rendered HTML into #summary-results
       - ENFORCE analyze bullet counts: Working ‚â§5, Needs ‚â•10 (ONLY change)
       - Render fallback scorecard (so the UI isn‚Äôt empty)
       - Wire up modal open/close and clipboard copy
       - Submit lead form to Formspree, then redirect to full-report
       --------------------------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", async () => {
      // 1) Read target URL from query and show it in the header.
      const urlParams = new URLSearchParams(window.location.search);
      const targetUrl = urlParams.get("url") || "https://example.com";
      document.getElementById("current-url").textContent = targetUrl;

      // 2) Load server-rendered analysis HTML (What‚Äôs Working / Needs Attention / AI insights)
      try {
        const res = await fetch(`https://sniperank-app2.onrender.com/report.html?url=${encodeURIComponent(targetUrl)}`);
        const html = await res.text();
        document.getElementById("summary-results").innerHTML = html;

        // >>> NEW: enforce counts for analyze (Working ‚â§5, Needs ‚â•10)
        try {
          const domain = new URL(targetUrl).hostname.replace(/^www\./, "");
          enforceAnalyzeCounts(document.getElementById("summary-results"), domain);
        } catch (e) {
          console.warn("Analyze bullet enforcement skipped:", e);
        }
      } catch {
        document.getElementById("summary-results").innerHTML = "<p style='text-align:center;color:red'>Error loading analysis.</p>";
      }

      // 3) Fallback score just to display a complete card even if API is unavailable.
      const p = { access:18, trust:17, clarity:19, alignment:18, freshness:16 };
      renderScoreCard(p.access+p.trust+p.clarity+p.alignment+p.freshness, p, [
        "Ensure consistent schema coverage (Org, WebSite, FAQ) across key templates.",
        "Add concise FAQ aligned to 'how/compare' prompts (4‚Äì6 non‚Äëoverlapping Q&As).",
        "Reinforce org identity: bylines/authorship, About/company snippet, and persistent contact path.",
        "Favor lists/Q&A/tables so AI can extract answers without parsing dense paragraphs."
      ]);

      // 4) Modal open/close (supports button + Esc + backdrop click)
      document.addEventListener('click', (e) => {
        if (e.target.closest('[data-open="sr-modal"]')) document.getElementById('sr-modal').setAttribute('aria-hidden','false');
        if (e.target.matches('[data-close]')) document.getElementById('sr-modal').setAttribute('aria-hidden','true');
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.getElementById('sr-modal').setAttribute('aria-hidden','true'); });

      // 5) ‚ÄúCopy Shareable Summary‚Äù ‚Üí builds a text block for email/LLMs and copies to clipboard
      document.getElementById("copyLLMBtn").addEventListener("click", async () => {
        const scoreText = document.getElementById("scoreNumber").textContent || "‚Äî/100";
        const labels = Array.from(document.querySelectorAll('.pillar .label')).map(el => el.textContent.trim());
        const vals = Array.from(document.querySelectorAll('.pillar .badge')).map(el => el.textContent.trim());
        const highlights = Array.from(document.querySelectorAll('#highlightsList li')).map(li => li.textContent.trim());
        const txt = [
          `Website: ${targetUrl}`,
          `SnipeRank Score: ${scoreText}`,
          `Pillars:`,
          ...labels.map((l,i)=>`- ${l}: ${vals[i]||''}`),
          ``,
          `Observed Highlights / Issues:`,
          ...highlights.map(h=>`- ${h}`),
          ``,
          `Next step ‚Äî talk with Quontora:`,
          `‚Ä¢ Book a free 30‚Äëminute consult: https://calendly.com/quontora`,
          `‚Ä¢ We‚Äôll deliver a tailored 30‚Äëday plan prioritized by Technical, Content, Schema, and Freshness.`
        ].join("\n");
        try{
          await navigator.clipboard.writeText(txt);
          const b=document.getElementById("copyLLMBtn"); const old=b.textContent; b.textContent="Copied!";
          setTimeout(()=>b.textContent=old,1500);
        }catch{
          window.prompt("Copy the summary:", txt);
        }
      });

      // 6) Formspree capture then redirect to full-report
      const form = document.getElementById("fullReportForm");
      const status = document.getElementById("formMessage");
      document.getElementById("urlField").value = targetUrl;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "üì§ Sending‚Ä¶";
        const fd = new FormData(form);
        fd.set("url", targetUrl);

        try {
          await fetch(form.action, { method: "POST", body: fd, headers: { "Accept": "application/json" } });
          status.textContent = "‚úÖ Thanks! Redirecting‚Ä¶";
        } catch {
          status.textContent = "‚ö†Ô∏è Couldn‚Äôt send just now, redirecting anyway.";
        } finally {
          const next = `/full-report.html?url=${encodeURIComponent(targetUrl)}`;
          window.location.href = next;
        }
      });

      // ----- helpers: render scorecard UI (total, band, pillars, highlights) -----
      function renderScoreCard(total, pillars, highlights){
        document.getElementById("scoreNumber").textContent = `${total}/100`;
        document.getElementById("scoreBand").textContent =
          total>=85?"Rank: Highly Visible ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ":total>=70?"Rank: Partially Visible ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ":total>=55?"Rank: Needs Work ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ":"Rank: Low Visibility ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ";

        const grid = document.getElementById("pillarsGrid");
        grid.innerHTML = "";
        [
          ["AI Access Readiness", pillars.access],
          ["Trust & Verification Signals", pillars.trust],
          ["LLM Interpretability & Clarity", pillars.clarity],
          ["Prompt-Pattern Alignment", pillars.alignment],
          ["Freshness & Engagement Signals", pillars.freshness],
        ].forEach(([label,val]) => {
          const d=document.createElement("div"); d.className="pillar";
          d.innerHTML = `<span class="label">${label}</span><span class="badge">${val}/20</span>`;
          grid.appendChild(d);
        });

        if (highlights?.length){
          const ul=document.getElementById("highlightsList");
          ul.innerHTML="";
          highlights.forEach(h=>{ const li=document.createElement("li"); li.textContent=h; ul.appendChild(li); });
          document.getElementById("highlightsBlock").hidden=false;
        }
      }

      /* ====================== NEW: Analyze bullet enforcement ====================== */

      function enforceAnalyzeCounts(root, domain){
        const workingUL = findULAfterTitle(root, /what'?s\s*working/i);
        const needsUL   = findULAfterTitle(root, /needs\s*attention/i);

        if (workingUL) {
          // Cap at 5, do not synthesize more
          capBullets(workingUL, 5);
        }
        if (needsUL) {
          // Ensure at least 10; synthesize short domain-specific items only if short
          ensureMinNeeds(needsUL, 10, makeNeedsShortTemplates(domain));
        }
      }

      function findULAfterTitle(root, rx){
        const h = Array.from(root.querySelectorAll("h2,h3,h4,.section-title"))
          .find(n => rx.test((n.textContent || "").trim()));
        if (!h) return null;
        let el = h.nextElementSibling;
        while (el && el.tagName && el.tagName.toLowerCase() !== "ul") el = el.nextElementSibling;
        return el && el.tagName && el.tagName.toLowerCase() === "ul" ? el : null;
      }

      function capBullets(ul, maxCount){
        const items = Array.from(ul.querySelectorAll("li"));
        if (items.length > maxCount){
          items.slice(maxCount).forEach(li => li.remove());
        }
      }

      function ensureMinNeeds(ul, minCount, templates){
        // De‚Äëdupe by subject (text before first colon), keep first occurrence
        const seen = new Set();
        Array.from(ul.querySelectorAll("li")).forEach(li => {
          const raw = (li.textContent || "").trim();
          const subj = (raw.split(":")[0] || raw).trim().toLowerCase();
          if (seen.has(subj)) li.remove(); else seen.add(subj);
        });

        let items = Array.from(ul.querySelectorAll("li"));

        if (items.length >= minCount) return;

        // Backfill with templates not already present
        for (const t of templates) {
          if (items.length >= minCount) break;
          const key = t.title.toLowerCase();
          if (seen.has(key)) continue;
          const li = document.createElement("li");
          li.innerHTML = `<strong>${escapeHTML(t.title)}:</strong> ${t.text}`;
          ul.appendChild(li);
          items.push(li);
          seen.add(key);
        }

        // If still short (rare), recycle with small domain tweak
        let i = 0;
        while (items.length < minCount && templates.length){
          const t = templates[i++ % templates.length];
          const li = document.createElement("li");
          const tweaked = t.text.replace(/( on | at )\S+/i, ` on ${t.domain}`);
          li.innerHTML = `<strong>${escapeHTML(t.title)}:</strong> ${tweaked}`;
          ul.appendChild(li);
          items.push(li);
        }
      }

      function escapeHTML(s){
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      // Short, 2‚Äì3 sentence domain‚Äëspecific templates for analyze backfill
      function makeNeedsShortTemplates(domain){
        const d = domain;
        return [
          { title: "Schema Markup Missing", text: `Entity markup is light on ${d}. Add Organization, WebSite, and FAQ on key templates and validate in Rich Results. Stronger signals help assistants attribute answers correctly.`, domain: d },
          { title: "Internal Linking Strategy", text: `Related pages on ${d} aren‚Äôt consistently interlinked. Build hubs and use descriptive anchors that mirror user questions. This clarifies answer paths for AI.`, domain: d },
          { title: "Content Depth & Clarity", text: `Some sections on ${d} mix promo copy with instructions. Separate tasks from marketing and add lists/tables. Clear steps improve extractability.`, domain: d },
          { title: "Heading Structure", text: `${d} reuses H1‚Äëlike headings or skips levels. Normalize to one H1 and logical H2/H3 ladders. Predictable spines reduce parsing errors.`, domain: d },
          { title: "Meta Titles & Descriptions", text: `Several titles/descriptions on ${d} don‚Äôt frame the primary answer. Tighten to outcome‚Äëfocused phrasing with a clear payoff. This boosts snippet eligibility.`, domain: d },
          { title: "Image Alt Text Gaps", text: `Important images on ${d} lack concise alt attributes. Add factual descriptors or mark decorative imagery correctly. Multimodal parsers rely on this.`, domain: d },
          { title: "Core Web Vitals", text: `First‚Äëscreen media and script weight on ${d} may affect LCP/INP. Optimize hero media and defer non‚Äëcritical JS. Stability aids snippet capture.`, domain: d },
          { title: "Canonicalization", text: `Near‚Äëduplicate content exists on ${d}. Point canonicals to a single source and standardize internal links to it. Consolidation strengthens authority.`, domain: d },
          { title: "Robots & Sitemaps", text: `robots.txt and sitemaps on ${d} could better highlight canonical answers. Remove stale URLs and surface preferred routes. This improves crawl spend.`, domain: d },
          { title: "FAQ Coverage", text: `Common ‚Äúhow/compare‚Äù questions are missing on ${d}. Add 4‚Äì6 precise Q&As per key page. Short answers map cleanly to assistant snippets.`, domain: d },
          { title: "Local Signals", text: `NAP details and service areas are thin on ${d}. Standardize address, hours, and regions and align profiles. Location cues steer local prompts.`, domain: d },
          { title: "Evidence & Citations", text: `Claims on ${d} often lack dates/citations. Add inline sources for stats and policies. Provenance increases quote‚Äëworthiness.`, domain: d },
          { title: "Thin Pages", text: `Some pages on ${d} provide limited task support. Expand with concrete steps, examples, and links to tools. Depth reduces deflection to aggregators.`, domain: d },
          { title: "Navigation Duplication", text: `${d} has overlapping nav labels that blur topic boundaries. Consolidate and use descriptive names. Clear IA improves intent targeting.`, domain: d },
          { title: "Breadcrumbs & Context", text: `Breadcrumbs on ${d} are missing or inconsistent. Add structured breadcrumbs to expose hierarchy. Context helps assistants disambiguate.`, domain: d },
          { title: "Media Weight", text: `Large uncompressed images/videos slow ${d}. Transcode, lazy‚Äëload below‚Äëthe‚Äëfold, and set proper dimensions. Faster pages parse more reliably.`, domain: d },
          { title: "Outdated Content", text: `Key pages on ${d} lack visible update cadence. Add last‚Äëmodified notes or slim changelogs. Freshness boosts assistant preference.`, domain: d },
          { title: "Contact Path", text: `Contact routes on ${d} are hard to find. Add a persistent footer snippet and link from About. Clear identity improves trust signals.`, domain: d },
          { title: "Anchor Text Consistency", text: `Anchors on ${d} are generic (‚Äúlearn more‚Äù). Rewrite to reflect the question/outcome. Descriptive anchors aid multi‚Äëhop reasoning.`, domain: d }
        ];
      }
      /* ==================== END: Analyze bullet enforcement (ONLY) =================== */
    });
  </script>
</body>
</html>
