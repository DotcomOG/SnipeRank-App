<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipeRank – Analyze</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fafafa;color:#111;margin:0}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 16px}
    form{display:flex;gap:8px;margin:16px 0 24px}
    input[type=url]{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:16px}
    button{padding:12px 16px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:14px;padding:16px 18px;box-shadow:0 2px 6px rgba(0,0,0,.04);margin-bottom:16px}
    .score-xl{font-size:48px;font-weight:800;letter-spacing:-.02em}
    .muted{color:#666}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #eaeaea;background:#fcfcfc}
    a.inline{font-weight:600;text-decoration:none;border-bottom:1px dashed #aaa;color:#111}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(720px,92vw);background:#fff;border-radius:14px;border:1px solid #eaeaea;padding:18px 18px 8px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .x{background:transparent;border:0;font-size:22px;cursor:pointer;padding:8px}
    .bullets{line-height:1.6;margin:8px 0 10px}
    /* Progress overlay */
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;z-index:40}
    .overlay .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,92vw);background:#fff;border:1px solid #eee;border-radius:14px;padding:18px}
    .bar{height:10px;border-radius:8px;background:#eee;overflow:hidden;margin-top:8px}
    .bar > div{height:100%;width:0%}
    .eta{margin-top:8px;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI SEO Analyze</h1>
    <form id="analyze-form">
      <input id="url" type="url" placeholder="https://example.com" required />
      <button id="goBtn" type="submit">Analyze</button>
    </form>

    <div id="result" class="card" style="display:none"></div>

    <div style="margin-top:8px" class="muted">Tip: After analysis, click “Full Report” to see details without recalculating.</div>
  </div>

  <!-- Progress overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <strong>Scanning your live website…</strong>
        <span id="pctLabel" class="muted">0%</span>
      </div>
      <div class="bar" aria-label="Progress"><div id="barFill"></div></div>
      <div id="eta" class="eta muted">Allow <strong>2–4 minutes</strong> as we scan and analyze your live website…</div>
    </div>
  </div>

  <!-- Score breakdown modal -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <header>
        <h3 id="mTitle" style="margin:6px 0">What goes into your score</h3>
        <button class="x" id="closeModal" aria-label="Close">×</button>
      </header>
      <div class="bullets">
        <ul>
          <li><strong>Structure &amp; Crawlability:</strong> sitemap, robots, canonical usage, link graph clarity.</li>
          <li><strong>Authority &amp; Trust:</strong> entity signals, organization schema, E-E-A-T hints, external mentions.</li>
          <li><strong>Clarity &amp; Language:</strong> headings hierarchy, readability, task intent match, duplication.</li>
          <li><strong>Content–AI Alignment:</strong> FAQability, snippetability, LLM context richness, retrieval clarity.</li>
          <li><em>Proprietary blend:</em> weighting &amp; thresholds intentionally obfuscated.</li>
        </ul>
      </div>
      <div style="text-align:right;padding:8px 0 12px">
        <button class="pill" id="okModal">Got it</button>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('analyze-form');
    const urlInput = document.getElementById('url');
    const result = document.getElementById('result');
    const overlay = document.getElementById('overlay');
    const barFill = document.getElementById('barFill');
    const pctLabel = document.getElementById('pctLabel');
    const eta = document.getElementById('eta');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const okModal = document.getElementById('okModal');

    // Faux-progress controller (nice for long-running fetch)
    function startProgress() {
      overlay.style.display = 'block';
      barFill.style.width = '0%';
      barFill.style.background = '#111';
      pctLabel.textContent = '0%';
      let p = 0;
      // Ease quickly at first, then slower; cap ~95% until real finish.
      return setInterval(() => {
        const increment = p < 60 ? 2.2 : p < 85 ? 0.8 : 0.2;
        p = Math.min(p + increment, 95);
        barFill.style.width = p + '%';
        pctLabel.textContent = Math.floor(p) + '%';
      }, 250);
    }
    function stopProgress() {
      overlay.style.display = 'none';
    }

    function showModal(show=true){
      modal.style.display = show ? 'flex' : 'none';
      modal.setAttribute('aria-hidden', show ? 'false' : 'true');
    }
    [closeModal, okModal].forEach(btn => btn.addEventListener('click', ()=>showModal(false)));
    modal.addEventListener('click', (e)=>{ if(e.target===modal) showModal(false); });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = urlInput.value.trim();
      if(!url) return;

      // Begin faux progress + ETA text
      let timer = startProgress();
      eta.innerHTML = 'Allow <strong>2–4 minutes</strong> as we scan and analyze your live website…';

      try {
        const resp = await fetch(`/api/friendly?url=${encodeURIComponent(url)}`);
        if(!resp.ok) throw new Error('Failed to load report');
        const report = await resp.json();

        // Persist for Full Report page to reuse (avoid re-running)
        sessionStorage.setItem('snipeReport:url', url);
        sessionStorage.setItem('snipeReport:data', JSON.stringify(report));

        // Render scorecard with breakdown link + Full Report button
        renderScore(report, url);
      } catch (err) {
        result.style.display = 'block';
        result.innerHTML = `<div class="muted">Error: ${err.message}</div>`;
      } finally {
        clearInterval(timer);
        // finish the bar nicely
        barFill.style.width = '100%'; pctLabel.textContent = '100%';
        setTimeout(stopProgress, 250);
      }
    });

    function renderScore(report, url){
      const score = report?.score ?? report?.data?.score ?? '—';
      const superpowers = report?.superpowers || [];
      const opportunities = report?.opportunities || [];

      result.style.display = 'block';
      result.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted" style="margin-bottom:6px">${url}</div>
            <div class="score-xl">${score}</div>
            <div class="muted">SnipeRank score</div>
            <div style="margin-top:10px">
              <a class="inline" href="#breakdown" id="openBreakdown">What goes into this score?</a>
            </div>
          </div>
          <div>
            <button id="fullBtn" class="pill">Full Report →</button>
          </div>
        </div>

        <div style="margin-top:14px" class="row">
          <span class="pill">Superpowers: ${superpowers.length}</span>
          <span class="pill">Opportunities: ${opportunities.length}</span>
        </div>
      `;

      document.getElementById('openBreakdown').addEventListener('click',(e)=>{ e.preventDefault(); showModal(true); });
      document.getElementById('fullBtn').addEventListener('click', ()=>{
        // Navigate without recalculating; full-report will read sessionStorage
        window.location.href = `full-report.html?url=${encodeURIComponent(url)}`;
      });
    }
  </script>
</body>
</html>

